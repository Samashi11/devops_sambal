name: Deploy to VPS

on:  
  push:
    branches:   
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on:   ubuntu-latest
    
    steps: 
    - name:  Checkout code
      uses:   actions/checkout@v4
      
    - name: Deploy to VPS via SSH
      uses:  appleboy/ssh-action@master
      with:
        host:   ${{ secrets.VPS_HOST }}
        username:  ${{ secrets.VPS_USERNAME }}
        key:  ${{ secrets.VPS_SSH_KEY }}
        script: |
          cd ${{ secrets.VPS_PATH }}
          
          echo "ğŸ“¥ Pulling latest code from GitHub..."
          git pull origin main
          
          echo "ğŸ›‘ Stopping containers..."
          docker compose down
          
          echo "ğŸ§¹ Cleaning old images..."
          docker image prune -f
          
          echo "ğŸ”¨ Building and starting containers..."
          docker compose up -d --build
          
          echo "â³ Waiting for containers to be ready..."
          sleep 15
          
          echo "ğŸ“¦ Installing Composer dependencies..."
          docker exec -it laravel_app composer install --no-dev --optimize-autoloader --no-interaction
          
          echo "ğŸ”„ Running Laravel migrations..."
          docker exec -it laravel_app php artisan migrate --force
          
          echo "âš¡ Optimizing Laravel..."
          docker exec -it laravel_app php artisan config:cache
          docker exec -it laravel_app php artisan route:cache
          docker exec -it laravel_app php artisan view:cache
          docker exec -it laravel_app php artisan optimize
          
          echo "ğŸ” Setting permissions..."
          docker exec -it laravel_app chown -R www-data:www-data /var/www/html/storage
          docker exec -it laravel_app chown -R www-data:www-data /var/www/html/bootstrap/cache
          
          echo "âœ… Deployment completed successfully!"
          
    - name:  Deployment Success
      if: success()
      run: |
        echo "ğŸ‰ Deployment to VPS successful!"
        echo "ğŸŒ Access your app at: http://${{ secrets.VPS_HOST }}: 8728"
        
    - name: Deployment Failed
      if: failure()
      run: |
        echo "âŒ Deployment failed!   Check the logs above."
